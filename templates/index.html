<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Stream</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            font-family: Arial, sans-serif;
        }

        aside {
            flex: 2;
            background: black;
            background-image: url('/static/cyber-hacker-attack-background-skull-vector.jpg');
            background-size: cover;
            background-position: left center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            padding: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: 15px;
            box-shadow: inset -5px 0 15px rgba(0, 0, 0, 0.3);
            color: #ffffff;
            overflow-y: auto;
            position: relative;
            /* Hide scrollbar for all browsers */
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }

        /* Dark overlay for aside to maintain readability */
        aside::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg,
                    rgba(26, 26, 26, 0.85) 0%,
                    rgba(45, 45, 45, 0.80) 50%,
                    rgba(0, 0, 0, 0.90) 100%);
            pointer-events: none;
            z-index: 1;
        }

        /* Ensure aside content is above the overlay */
        aside>* {
            position: relative;
            z-index: 2;
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        aside::-webkit-scrollbar {
            display: none;
        }

        .mode-button {
            background: linear-gradient(135deg, rgba(255, 102, 0, 0.8), rgba(255, 102, 0, 0.6));
            border: 2px solid #ff6600;
            border-radius: 12px;
            color: #ffffff;
            font-family: Arial, sans-serif;
            font-size: 14px;
            font-weight: bold;
            padding: 14px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            min-width: 200px;
            box-shadow: 0 4px 15px rgba(255, 102, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .mode-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }

        .mode-button:hover::before {
            left: 100%;
        }

        .mode-button:hover {
            background: linear-gradient(135deg, rgba(255, 102, 0, 1), rgba(255, 102, 0, 0.8));
            border-color: #ffaa55;
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(255, 102, 0, 0.4);
        }

        .mode-button.weapon {
            border-color: #ff0000;
            background: linear-gradient(135deg, rgba(255, 0, 0, 0.8), rgba(255, 0, 0, 0.6));
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.2);
        }

        .mode-button.weapon:hover {
            background: linear-gradient(135deg, rgba(255, 0, 0, 1), rgba(255, 0, 0, 0.8));
            border-color: #ff5555;
            box-shadow: 0 6px 20px rgba(255, 0, 0, 0.4);
        }

        .mode-button.pose {
            border-color: #00ff00;
            background: linear-gradient(135deg, rgba(0, 255, 0, 0.8), rgba(0, 255, 0, 0.6));
            box-shadow: 0 4px 15px rgba(0, 255, 0, 0.2);
        }

        .mode-button.pose:hover {
            background: linear-gradient(135deg, rgba(0, 255, 0, 1), rgba(0, 255, 0, 0.8));
            border-color: #55ff55;
            box-shadow: 0 6px 20px rgba(0, 255, 0, 0.4);
        }

        .mode-status {
            text-align: center;
            font-weight: bold;
            font-size: 14px;
            color: #ffffff;
            margin-top: 8px;
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .debug-info {
            color: #ff6b00;
            font-size: 11px;
            text-align: center;
            font-family: Arial, sans-serif;
            font-weight: 500;
            margin-top: 15px;
            padding: 10px 12px;
            background: linear-gradient(135deg, #1e1e1e 0%, #2a2a2a 100%);
            border-radius: 8px;
            border: 1px solid #444;
            min-height: 24px;
            box-shadow: 0 2px 10px rgba(255, 107, 0, 0.1);
            transition: all 0.3s ease;
        }

        .video-container {
            flex: 9;
            background: black;
            background-image: url('/static/cyber-hacker-attack-background-skull-vector.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .video-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1;
        }

        .center-border-box {
            width: 50%;
            height: 50%;
            border: 3px solid red;
            border-radius: 8px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .center-border-box.blink {
            animation: blink-border 0.5s steps(1, start) infinite;
        }

        @keyframes blink-border {

            0%,
            100% {
                border-color: red;
                box-shadow: 0 0 20px 5px #ff0000;
            }

            50% {
                border-color: yellow;
                box-shadow: 0 0 20px 10px #ffff00;
            }
        }

        .bomb-alert-text {
            color: #fff;
            font-size: 2.2vw;
            font-weight: bold;
            text-shadow: 0 0 10px #ff0000, 0 0 20px #ff0;
            background: rgba(255, 0, 0, 0.7);
            border-radius: 10px;
            padding: 18px 32px;
            border: 2px solid #fff200;
            animation: blink-text 0.5s steps(1, start) infinite;
            letter-spacing: 2px;
        }

        @keyframes blink-text {

            0%,
            100% {
                color: #fff;
                background: rgba(255, 0, 0, 0.7);
                border-color: #fff200;
            }

            50% {
                color: #ff0;
                background: rgba(255, 0, 0, 0.3);
                border-color: #ff0000;
            }
        }

        .center-border-box.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .toggle-border-button {
            background: linear-gradient(135deg, rgba(128, 128, 128, 0.8), rgba(128, 128, 128, 0.6));
            border: 2px solid #808080;
            border-radius: 12px;
            color: #ffffff;
            font-family: Arial, sans-serif;
            font-size: 14px;
            font-weight: bold;
            padding: 14px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            min-width: 200px;
            box-shadow: 0 4px 15px rgba(128, 128, 128, 0.2);
            position: relative;
            overflow: hidden;
        }

        .toggle-border-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }

        .toggle-border-button:hover::before {
            left: 100%;
        }

        .toggle-border-button:hover {
            background: linear-gradient(135deg, rgba(128, 128, 128, 1), rgba(128, 128, 128, 0.8));
            border-color: #a0a0a0;
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(128, 128, 128, 0.4);
        }

        .toggle-border-button.show {
            border-color: #0080ff;
            background: linear-gradient(135deg, rgba(0, 128, 255, 0.8), rgba(0, 128, 255, 0.6));
            box-shadow: 0 4px 15px rgba(0, 128, 255, 0.2);
        }

        .toggle-border-button.show:hover {
            background: linear-gradient(135deg, rgba(0, 128, 255, 1), rgba(0, 128, 255, 0.8));
            border-color: #4d9fff;
            box-shadow: 0 6px 20px rgba(0, 128, 255, 0.4);
        }

        .video-stream {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .sensor-panel {
            background: linear-gradient(135deg, #1e1e1e 0%, #2a2a2a 100%);
            border: 2px solid #ff6b00;
            border-radius: 12px;
            padding: 20px;
            color: #ffffff;
            font-family: Arial, sans-serif;
            font-size: 13px;
            min-width: 200px;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(255, 107, 0, 0.2);
            transition: all 0.3s ease;
        }

        .sensor-panel:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 0, 0.3);
        }

        .sensor-title {
            text-align: center;
            font-weight: bold;
            margin-bottom: 15px;
            color: #ff6b00;
            background: linear-gradient(45deg, #ff6b00, #ff8800);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            border-bottom: 2px solid #ff6b00;
            padding-bottom: 8px;
            font-size: 16px;
            text-transform: uppercase;
            text-shadow: 0 0 10px rgba(255, 107, 0, 0.3);
        }

        .sensor-item {
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 6px;
            border-left: 3px solid #ff6b00;
            transition: all 0.3s ease;
        }

        .sensor-item:hover {
            background: rgba(255, 107, 0, 0.1);
            transform: translateX(3px);
        }

        .sensor-label {
            color: #cccccc;
            font-weight: 600;
        }

        .sensor-value {
            color: #ff6b00;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(255, 107, 0, 0.5);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff0000;
            display: inline-block;
            margin-right: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.6;
                transform: scale(0.9);
            }
        }
    </style>
</head>

<body>
    <aside>
        <h1
            style="margin: 0 0 0 0; font-size: 60px; background: white; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-shadow: 0 0 20px rgba(255, 102, 0, 0.3); letter-spacing: 2px;">
            MALEO</h1>
        <!-- Tabel waktu, tanggal, aktif di pojok kiri bawah -->
        <div style="position:absolute;left:20px;bottom:10px;z-index:3;">
            <table
                style="font-size:14px;color:#fff;background:rgba(0,0,0,0.3);border-radius:8px;padding:2px px;box-shadow:0 2px 8px #000;">

                <tr>
                    <td>DATE</td>
                    <td id="currentDate">--/--/----</td>
                </tr>
                <tr>
                    <td style="color:#ffb300;">TIME</td>
                    <td id="currentTime">--:--:--</td>
                </tr>
                <tr>
                    <td>ACTIVE</td>
                    <td id="activeTime">00:00:00</td>
                </tr>
            </table>
        </div>
        <p style="text-align: center; margin-bottom: 10px;">
            <span id="liveDot"
                style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#ff0000;margin-right:8px;vertical-align:middle;box-shadow:0 0 8px #ff0000;"></span>Livestream
        </p>
        <script>
            // Kedut-kedut animasi untuk titik merah
            const liveDot = document.getElementById('liveDot');
            let visible = true;
            setInterval(() => {
                visible = !visible;
                liveDot.style.opacity = visible ? '1' : '0.3';
                liveDot.style.transform = visible ? 'scale(1.1)' : 'scale(0.8)';
            }, 500);

            // Tabel waktu, tanggal, aktif
            let startTime = Date.now();
            function updateActiveTime() {
                let now = Date.now();
                let diff = Math.floor((now - startTime) / 1000);
                let hours = String(Math.floor(diff / 3600)).padStart(2, '0');
                let minutes = String(Math.floor((diff % 3600) / 60)).padStart(2, '0');
                let seconds = String(diff % 60).padStart(2, '0');
                document.getElementById('activeTime').textContent = `${hours}:${minutes}:${seconds}`;
            }
            function updateCurrentDate() {
                const now = new Date();
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                document.getElementById('currentDate').textContent = `${day}/${month}/${year}`;
            }
            function updateCurrentTime() {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                document.getElementById('currentTime').textContent = `${hours}:${minutes}:${seconds}`;
            }
            setInterval(() => {
                updateActiveTime();
                updateCurrentTime();
            }, 1000);
            updateActiveTime();
            updateCurrentDate();
            updateCurrentTime();
        </script>

        <!-- Sensor Data Panel -->
        <div class="sensor-panel">
            <div class="sensor-title">
                <span id="statusIndicator" class="status-indicator"></span>
                SENSOR DATA
            </div>
            <div class="sensor-item">
                <span class="sensor-label">Temperature:</span>
                <span class="sensor-value" id="temperature">--°C</span>
            </div>
            <div class="sensor-item">
                <span class="sensor-label">Humidity:</span>
                <span class="sensor-value" id="humidity">--%</span>
            </div>
            <div class="sensor-item">
                <span class="sensor-label">Last Update:</span>
                <span class="sensor-value" id="lastUpdate">--</span>
            </div>
        </div>

        <button class="mode-button weapon" id="modeToggleBtn" onclick="toggleMode(); showButtonFeedback();">
            SWITCH TO POSE MODE
        </button>
        <div class="mode-status" id="currentMode">
            Current: WEAPON MODE
        </div>
        <div class="debug-info" id="debugInfo">
            Ready
        </div>
        <!-- Tombol border disembunyikan -->
    </aside>

    <main class="video-container">
        <!-- Video background -->
        <video id="bgVideo" autoplay loop muted playsinline
            style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:0;">
            <source src="/static/background.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        <!-- Konten utama di atas video background -->
        <img id="videoStream" class="video-stream" src="/video_feed" alt="Video Stream"
            style="position:relative;z-index:2;">
        <div class="center-border-box hidden" id="bombBorder" style="z-index:3;">
            <span class="bomb-alert-text" id="bombText" style="display:none;">INDICATED</span>
        </div>
    </main>

    <script>
        let currentMode = 'weapon'; // Track current mode - default to weapon since server starts with weapon active

        function toggleMode() {
            console.log('🔄 Toggle mode clicked');
            updateDebugInfo('Toggling mode...');

            // Try fetch first, fallback to XMLHttpRequest for older browsers
            if (typeof fetch !== 'undefined') {
                fetch('/toggle_mode')
                    .then(response => {
                        console.log('📡 Response received:', response.status);
                        updateDebugInfo('Response: ' + response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('📦 Data received:', data);
                        // Use the frontend mode from server response
                        currentMode = data.detection_mode;
                        updateModeUI();
                        updateDebugInfo('✅ ' + data.detection_mode + ' mode');
                        console.log('✅ Mode updated to:', currentMode);
                    })
                    .catch(error => {
                        console.error('❌ Fetch error:', error);
                        updateDebugInfo('❌ Fetch failed, trying XHR...');
                        // Fallback to XMLHttpRequest
                        toggleModeXHR();
                    });
            } else {
                // Fallback for older browsers
                updateDebugInfo('Using XHR fallback...');
                toggleModeXHR();
            }
        }

        function toggleModeXHR() {
            console.log('🔄 Using XMLHttpRequest fallback');
            updateDebugInfo('XHR request...');
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/toggle_mode', true);
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            var data = JSON.parse(xhr.responseText);
                            console.log('📦 XHR Data received:', data);
                            currentMode = data.detection_mode;
                            updateModeUI();
                            updateDebugInfo('✅ XHR ' + data.detection_mode + ' mode');
                            console.log('✅ XHR Mode updated to:', currentMode);
                        } catch (e) {
                            console.error('❌ XHR JSON parse error:', e);
                            updateDebugInfo('❌ XHR parse error');
                        }
                    } else {
                        console.error('❌ XHR error:', xhr.status);
                        updateDebugInfo('❌ XHR error: ' + xhr.status);
                    }
                }
            };
            xhr.send();
        }

        function updateModeUI() {
            const modeButton = document.getElementById('modeToggleBtn');
            const currentModeText = document.getElementById('currentMode');

            if (currentMode === 'weapon') {
                modeButton.textContent = 'SWITCH TO POSE MODE';
                modeButton.className = 'mode-button weapon';
                currentModeText.textContent = 'Current: WEAPON MODE';
            } else {
                modeButton.textContent = 'SWITCH TO WEAPON MODE';
                modeButton.className = 'mode-button pose';
                currentModeText.textContent = 'Current: POSE MODE';
            }
        }

        function fetchCurrentMode() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    if (data.ai_detection && data.ai_detection.detection_mode) {
                        currentMode = data.ai_detection.detection_mode;
                        updateModeUI();
                        updateDebugInfo('Loaded: ' + currentMode + ' mode');
                    }
                })
                .catch(error => {
                    console.error('Error fetching status:', error);
                    updateDebugInfo('❌ Status fetch failed');
                });
        }

        function showButtonFeedback() {
            const button = document.getElementById('modeToggleBtn');
            const debugInfo = document.getElementById('debugInfo');

            // Visual feedback
            button.style.transform = 'scale(0.95)';
            button.style.opacity = '0.7';
            debugInfo.textContent = 'Button clicked...';

            setTimeout(() => {
                button.style.transform = 'scale(1)';
                button.style.opacity = '1';
            }, 200);
        }

        function updateDebugInfo(message) {
            const debugInfo = document.getElementById('debugInfo');
            if (debugInfo) {
                debugInfo.textContent = message;
            }
        }

        function setBorder(show) {
            const borderBox = document.querySelector('.center-border-box');
            const toggleBtn = document.getElementById('toggleBorderBtn');

            if (show) {
                // Show border
                borderBox.classList.remove('hidden');
                toggleBtn.textContent = 'BORDER ON';
                toggleBtn.className = 'toggle-border-button show';
            } else {
                // Hide border
                borderBox.classList.add('hidden');
                toggleBtn.textContent = 'BORDER OFF';
                toggleBtn.className = 'toggle-border-button';
            }
        }

        // Legacy function for manual toggle (if needed)
        function toggleBorder() {
            const borderBox = document.querySelector('.center-border-box');
            const isHidden = borderBox.classList.contains('hidden');
            setBorder(isHidden);
        }

        function updateSensorData() {
            fetch('/get_sensor_data')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('temperature').textContent = data.temperature.toFixed(1) + '°C';
                    document.getElementById('humidity').textContent = data.humidity.toFixed(1) + '%';

                    const lastUpdate = data.last_update;
                    const statusIndicator = document.getElementById('statusIndicator');

                    if (lastUpdate < 10) {
                        statusIndicator.className = 'status-indicator connected';
                        document.getElementById('lastUpdate').textContent = 'Active';
                    } else {
                        statusIndicator.className = 'status-indicator';
                        document.getElementById('lastUpdate').textContent = lastUpdate.toFixed(0) + 's ago';
                    }
                })
                .catch(error => {
                    console.error('Error fetching sensor data:', error);
                    document.getElementById('statusIndicator').className = 'status-indicator';
                    document.getElementById('lastUpdate').textContent = 'Error';
                    document.getElementById('temperature').textContent = 'N/A';
                    document.getElementById('humidity').textContent = 'N/A';
                });
        }

        // Initialize
        fetchCurrentMode(); // Get initial mode from server
        updateSensorData(); // Get initial sensor data
        setInterval(updateSensorData, 2000); // Update sensor data every 2 seconds

        // Debug info
        updateDebugInfo('System ready - ' + new Date().toLocaleTimeString());
    </script>

    <script>
        setInterval(() => {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    const borderBox = document.getElementById('bombBorder');
                    const bombText = document.getElementById('bombText');
                    if (data.buzzer === "ON") {
                        borderBox.classList.remove('hidden');
                        borderBox.classList.add('blink');
                        bombText.style.display = '';
                    } else {
                        borderBox.classList.add('hidden');
                        borderBox.classList.remove('blink');
                        bombText.style.display = 'none';
                    }
                })
                .catch(err => console.error('Error fetching buzzer status:', err));
        }, 200);
    </script>

</body>

</html>